<!DOCTYPE html>
<html>
  <head>
    <title>Flower Power</title>
  </head>
  <body>
    <main id='inventory'></main>
    <button id='showByFlower'>view info by flower</button>
    <button id='showTotal'>view totals</button>
    
    <script src="js/vendor/Chart.min.js"></script>
    <script src="js/vendor/lodash.min.js"></script>
    <script>
      var rawData = [
        {
          "flower": "tulip", 
          "date": "2/3/2012", 
          "quantity-sold": "20", 
          "quantity-unsold": "10"
        },
        {
          "flower": "tulip", 
          "date": "2/4/2012", 
          "quantity-sold": "18", 
          "quantity-unsold": "12"
        },
        {
          "flower": "tulip", 
          "date": "2/5/2012", 
          "quantity-sold": "23", 
          "quantity-unsold": "7"
        },
        {
          "flower": "tulip", 
          "date": "2/6/2012", 
          "quantity-sold": "15", 
          "quantity-unsold": "20"
        },
        {
          "flower": "tulip", 
          "date": "2/7/2012", 
          "quantity-sold": "12", 
          "quantity-unsold": "23"
        },
        {
          "flower": "rose", 
          "date": "2/3/2012", 
          "quantity-sold": "50", 
          "quantity-unsold": "40"
        },
        {
          "flower": "rose", 
          "date": "2/4/2012", 
          "quantity-sold": "43", 
          "quantity-unsold": "47"
        },
        {
          "flower": "rose", 
          "date": "2/5/2012", 
          "quantity-sold": "55", 
          "quantity-unsold": "35"
        },
        {
          "flower": "rose", 
          "date": "2/6/2012", 
          "quantity-sold": "70", 
          "quantity-unsold": "20"
        },
        {
          "flower": "rose", 
          "date": "2/7/2012", 
          "quantity-sold": "30", 
          "quantity-unsold": "70"
        },
        {
          "flower": "dandelion", 
          "date": "2/3/2012", 
          "quantity-sold": "10", 
          "quantity-unsold": "0"
        },
        {
          "flower": "dandelion", 
          "date": "2/4/2012", 
          "quantity-sold": "9", 
          "quantity-unsold": "11"
        },
        {
          "flower": "dandelion", 
          "date": "2/5/2012", 
          "quantity-sold": "3", 
          "quantity-unsold": "17"
        },
        {
          "flower": "dandelion", 
          "date": "2/6/2012", 
          "quantity-sold": "4", 
          "quantity-unsold": "16"
        },
        {
          "flower": "dandelion", 
          "date": "2/7/2012", 
          "quantity-sold": "7", 
          "quantity-unsold": "8"
        }
      ]
    </script>
      
    <script>
      
      function Dashboard(el, data) {
        this.el = el;
        this.currentView = {
          property: 'sold',
          showTotal: true
        };
        this.chartOptions = {}
        
        this.dataByDate = this.breakOutDataByDate(data);
        this.datasetDefaults = this.generateDefaults;
      }
      
      Dashboard.prototype.generateDefaults = function () {
        return {}
      };
      
      Dashboard.prototype.breakOutDataByDate = function (rawData) {
        var dates = [];
      
        rawData.forEach(function (blob) {
          var date = blob.date;
          if (dates.indexOf(date) === -1) {
            dates.push(date);
          }
        });
      
        // build object with dates as keys
        var dataByDate = {};
        dates.forEach(function (date) {
          var dateInfo = dataByDate[date] = {};
        
          rawData.forEach(function (blob) {
            if (blob.date === date) {
              var flowerInfo = dateInfo[blob.flower] = {};
              var quantSold = parseInt(blob['quantity-sold']);
              var quantUnsold = parseInt(blob['quantity-unsold']);
              flowerInfo['sold'] = quantSold;
              flowerInfo['unsold'] = quantUnsold;
              flowerInfo['delivered'] = quantSold + quantUnsold;
            }
          });
        });
      
        return dataByDate;
      }
      
      Dashboard.prototype.showChart = function () {
        var data;
        
        if (this.currentView.showTotal) {
          data = this.dailyTotalsForProperty();
        } else {
          data = this.dailyByFlowerForProperty();          
        }
        
        // empty contents of this.el if it has contents
        while (this.el.firstChild) {
          this.el.removeChild(this.el.firstChild);
        }
        
        // create a new canvas element to avoid stacking charts on top of one another.
        var canvas = document.createElement('canvas');
        canvas.height = 300;
        canvas.width = 600;
        this.el.appendChild(canvas);
        
        var ctx = canvas.getContext('2d');
        this.flowerChart = new Chart(ctx).Bar(data, this.chartOptions);
        
        return this;
      };
      
      Dashboard.prototype.dailyTotalsForProperty = function () {
        var labels = Object.keys(this.dataByDate);
        var dataset = _.assign({
          label: "total flowers " + this.currentView.property,
          data: []
        }, this.datasetDefaults['total']);
        
        var dashboard = this;
        labels.forEach(function (label) {
          var totalSold = 0;
          var date = dashboard.dataByDate[label];
          for (var flower in date) {
            totalSold += date[flower][dashboard.currentView.property];
          };
        
          dataset.data.push(totalSold);
        });
      
        return {
          labels: labels,
          datasets: [dataset]
        };
      };
      
      Dashboard.prototype.dailyByFlowerForProperty = function () {
        var labels = Object.keys(this.dataByDate);
        var datasetObj = {};
        
        var datasetDefaults = {
          fillColor: "rgba(151,187,205,0.5)",
          strokeColor: "rgba(151,187,205,0.8)",
          highlightFill: "rgba(151,187,205,0.75)",
          highlightStroke: "rgba(151,187,205,1)",
        };
        
        // get flower names
        var flowers = [];
        for (var dateBlob in this.dataByDate) {
          var dateBlob = this.dataByDate[dateBlob];
          _.forIn(dateBlob, function (data, flower) {
            if (!_.contains(flowers, flower)) {
              flowers.push(flower);
            }      
          })
        }
        
        var dashboard = this;
        _.each(flowers, function (flower) {
          var dataset = datasetObj[flower] = _.assign({ 
            label: flower,
            data: []
          }, dashboard.datasetDefaults[flower]);
          
          labels.forEach(function (label) {
            var dateBlob = dashboard.dataByDate[label];
            dataset.data.push(dateBlob[flower][dashboard.currentView.property]);
          });
        });
        
        
        var datasetArr = [];
        for (var key in datasetObj) {
          datasetArr.push(datasetObj[key]);
        }
      
        return {
          labels: labels,
          datasets: datasetArr
        };
      }
      
      
      var dashboard = new Dashboard(inventory, rawData).showChart();
      
      showByFlower.onclick = (function () {
        dashboard.currentView.showTotal = false;
        dashboard.showChart();
        return false;
      });
      
      showTotal.onclick = (function () {
        dashboard.currentView.showTotal = true;
        dashboard.showChart();
        return false;
      });
      
    </script>
    
  </body>
  
</html>