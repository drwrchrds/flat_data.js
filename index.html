<!DOCTYPE html>
<html>
  <head>
    <title>Flower Power</title>
  </head>
  <body>
    <main id='inventory'></main>
    <button id='showByFlower'>view info by flower</button>
    <button id='showCombined'>all inventory</button>
    <button id='showDelivered'>starting inventory</button>
    <button id='showSoldCount'>flowers sold (actual)</button>
    <button id='showSoldPercent'>flowers sold (%)</button>
    <!-- <button id='showUnsold'>flowers remaining</button> -->
    
    <script src="js/vendor/Chart.min.js"></script>
    <script src="js/vendor/KolorWheel.min.js"></script>
    <script src="js/vendor/lodash.min.js"></script>
    <script>
      var rawData = [
        {
          "flower": "tulip", 
          "date": "2/3/2012", 
          "quantity-sold": "20", 
          "quantity-unsold": "10"
        },
        {
          "flower": "tulip", 
          "date": "2/4/2012", 
          "quantity-sold": "18", 
          "quantity-unsold": "12"
        },
        {
          "flower": "tulip", 
          "date": "2/5/2012", 
          "quantity-sold": "23", 
          "quantity-unsold": "7"
        },
        {
          "flower": "tulip", 
          "date": "2/6/2012", 
          "quantity-sold": "15", 
          "quantity-unsold": "20"
        },
        {
          "flower": "tulip", 
          "date": "2/7/2012", 
          "quantity-sold": "12", 
          "quantity-unsold": "23"
        },
        {
          "flower": "rose", 
          "date": "2/3/2012", 
          "quantity-sold": "50", 
          "quantity-unsold": "40"
        },
        {
          "flower": "rose", 
          "date": "2/4/2012", 
          "quantity-sold": "43", 
          "quantity-unsold": "47"
        },
        {
          "flower": "rose", 
          "date": "2/5/2012", 
          "quantity-sold": "55", 
          "quantity-unsold": "35"
        },
        {
          "flower": "rose", 
          "date": "2/6/2012", 
          "quantity-sold": "70", 
          "quantity-unsold": "20"
        },
        {
          "flower": "rose", 
          "date": "2/7/2012", 
          "quantity-sold": "30", 
          "quantity-unsold": "70"
        },
        {
          "flower": "dandelion", 
          "date": "2/3/2012", 
          "quantity-sold": "10", 
          "quantity-unsold": "0"
        },
        {
          "flower": "dandelion", 
          "date": "2/4/2012", 
          "quantity-sold": "9", 
          "quantity-unsold": "11"
        },
        {
          "flower": "dandelion", 
          "date": "2/5/2012", 
          "quantity-sold": "3", 
          "quantity-unsold": "17"
        },
        {
          "flower": "dandelion", 
          "date": "2/6/2012", 
          "quantity-sold": "4", 
          "quantity-unsold": "16"
        },
        {
          "flower": "dandelion", 
          "date": "2/7/2012", 
          "quantity-sold": "7", 
          "quantity-unsold": "8"
        }
      ]
    </script>

    <script>
      
      function Dashboard(el, data) {
        this.dataByDate = this.breakOutDataByDate(data);
        
        this.el = el;
        this.currentView = {
          property: 'sold',
          showCombined: true,
          showPercent: true
        };
      }
      
      Dashboard.prototype.columns = function () {
        if(!this._columns) {
          this._columns = _.keys(this.dataByDate[_.keys(this.dataByDate)[0]]);
        }
        return this._columns;
      };
      
      Dashboard.prototype.chartOptions = function () {
        
      };
      
      Dashboard.prototype.flowers = function () {
        return _.without(this.columns(), 'total');
      };
      
      Dashboard.prototype.colorDefaults = function () {
        if (!this._colorDefaults) {
          this._colorDefaults = {}
          var hue = ~~(Math.random() * 360);
          _.each(this.columns(), function (columnName) {
            var baseColor = new KolorWheel([hue, 30, 50]);
            var rgb = baseColor.getRgb().toString();
            
            this._colorDefaults[columnName] = {
              fillColor: "rgba(" + rgb + ",0.6)",
              strokeColor: "rgba(" + rgb + ",0.8)",
              highlightFill: "rgba(" + rgb + ",0.75)",
              highlightStroke: "rgba(" + rgb + ",1)",
            }
            hue += 67;
          }.bind(this));
        }
 
        return this._colorDefaults;
      };
      
      Dashboard.prototype.breakOutDataByDate = function (rawData) {
        var dates = _.map(rawData, 'date');
      
        // build object with dates as keys
        var dataByDate = {};
        dates.forEach(function (date) {
          var dateInfo = dataByDate[date] = {};
        
          rawData.forEach(function (blob) {
            if (blob.date === date) {
              var flowerInfo = dateInfo[blob.flower] = {};
              var quantSold = parseInt(blob['quantity-sold']);
              var quantUnsold = parseInt(blob['quantity-unsold']);
              var startingInventory = quantSold + quantUnsold;
              
              flowerInfo.sold = quantSold;
              flowerInfo.unsold = quantUnsold;
              flowerInfo.startingInventory = startingInventory;
            }
          });
        });
        
        this.addTotals(dataByDate);
        
        return dataByDate;
      };
      
      Dashboard.prototype.addTotals = function (dataByDate) {
        _.forIn(dataByDate, function (dateBlob) {
          var total = dateBlob.total = {};
          _.forIn(dateBlob, function (flowerBlob, flowerName) {
            if (flowerName === 'total') return;
            _.forIn(flowerBlob, function (value, attrName) {
              if (!total[attrName]) total[attrName] = 0;
              total[attrName] += value;
            });
          });
        });
      };
      
      Dashboard.prototype.labels = function () {
        return _.keys(this.dataByDate);
      };
      
      Dashboard.prototype.dateStrings = function () {
        return _.map(this.labels(), function (label) { 
          return new Date(label).toDateString();
        });
      };
      
      Dashboard.prototype.buildDataForChart = function () {
        var datasetArr;
        if (this.currentView.showCombined) {
          datasetArr = this.combinedData();
        } else {
          datasetArr = this.flowerData();
        }
        
        return {
          labels: this.dateStrings(),
          datasets: datasetArr
        };
      };
      
      Dashboard.prototype.showChart = function () {
        
        // empty contents of this.el if it has contents
        while (this.el.firstChild) {
          this.el.removeChild(this.el.firstChild);
        }
        
        // create a new canvas element to avoid stacking charts on top of one another.
        var canvas = document.createElement('canvas');
        canvas.height = 300;
        canvas.width = 600;
        this.el.appendChild(canvas);
        
        var ctx = canvas.getContext('2d');
        new Chart(ctx).Bar(this.buildDataForChart(), this.chartOptions());
        return this;
      };
      
      Dashboard.prototype.buildDatasetForColumn = function (column) {
        var dataset = _.assign({ 
          label: column + ' ' + this.currentView.property,
          data: []
        }, this.colorDefaults()[column]);
        
        this.labels().forEach(function (label) {
          var dateBlob = this.dataByDate[label];
          var value = dateBlob[column][this.currentView.property];
          
          if (this.currentView.showPercent) {
            value = value / dateBlob[column]['startingInventory'] * 100;
          }
          dataset.data.push(value);
        }.bind(this));
        
        return dataset;
      };
      
      Dashboard.prototype.flowerData = function () {
        return _.map(this.flowers(), function (flower) {
          return this.buildDatasetForColumn(flower);
        }.bind(this));
      };
      
      Dashboard.prototype.combinedData = function () {
        return [this.buildDatasetForColumn('total')];
      };
      
      Dashboard.prototype.updateView = function (viewOptions) {
        _.assign(this.currentView, viewOptions);
        this.showChart();
      };
      
      
      var dashboard = new Dashboard(inventory, rawData).showChart();
      
      showByFlower.onclick = function () {
        dashboard.updateView({ showCombined: false });
        return false;
      };
      
      showCombined.onclick = function () {
        dashboard.updateView({ showCombined: true });
        return false;
      };
      
      showSoldCount.onclick = function () {
        dashboard.updateView({ 
          property: 'sold',
          showPercent: false
        });
        return false;
      };
      
      showSoldPercent.onclick = function () {
        dashboard.updateView({ 
          property: 'sold',
          showPercent: true
        });
        return false;
      };
      
      // showUnsold.onclick = function () {
      //   dashboard.updateView({ 'property': 'unsold' });
      //   return false;
      // };
      //
      showDelivered.onclick = function () {
        dashboard.updateView({ 'property': 'delivered' });
        return false;
      };
      
    </script>
    
  </body>
  
</html>