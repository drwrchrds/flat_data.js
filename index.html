<!DOCTYPE html>
<html>
  <head>
    <title>Flower Power</title>
  </head>
  <body>
    <canvas 
      id='inventory' 
      width='700' 
      height='300' 
      style='border: thin solid black;'>
    </canvas>
    <button id='showByFlower'>view info by flower</button>
    <button id='showTotal'>view totals</button>
    
    <script src="js/vendor/Chart.min.js"></script>
    <script src="js/vendor/lodash.min.js"></script>
    <script>
      var rawData = [
        {
          "flower": "tulip", 
          "date": "2/3/2012", 
          "quantity-sold": "20", 
          "quantity-unsold": "10"
        },
        {
          "flower": "tulip", 
          "date": "2/4/2012", 
          "quantity-sold": "18", 
          "quantity-unsold": "12"
        },
        {
          "flower": "tulip", 
          "date": "2/5/2012", 
          "quantity-sold": "23", 
          "quantity-unsold": "7"
        },
        {
          "flower": "tulip", 
          "date": "2/6/2012", 
          "quantity-sold": "15", 
          "quantity-unsold": "20"
        },
        {
          "flower": "tulip", 
          "date": "2/7/2012", 
          "quantity-sold": "12", 
          "quantity-unsold": "23"
        },
        {
          "flower": "rose", 
          "date": "2/3/2012", 
          "quantity-sold": "50", 
          "quantity-unsold": "40"
        },
        {
          "flower": "rose", 
          "date": "2/4/2012", 
          "quantity-sold": "43", 
          "quantity-unsold": "47"
        },
        {
          "flower": "rose", 
          "date": "2/5/2012", 
          "quantity-sold": "55", 
          "quantity-unsold": "35"
        },
        {
          "flower": "rose", 
          "date": "2/6/2012", 
          "quantity-sold": "70", 
          "quantity-unsold": "20"
        },
        {
          "flower": "rose", 
          "date": "2/7/2012", 
          "quantity-sold": "30", 
          "quantity-unsold": "70"
        },
        {
          "flower": "dandelion", 
          "date": "2/3/2012", 
          "quantity-sold": "10", 
          "quantity-unsold": "0"
        },
        {
          "flower": "dandelion", 
          "date": "2/4/2012", 
          "quantity-sold": "9", 
          "quantity-unsold": "11"
        },
        {
          "flower": "dandelion", 
          "date": "2/5/2012", 
          "quantity-sold": "3", 
          "quantity-unsold": "17"
        },
        {
          "flower": "dandelion", 
          "date": "2/6/2012", 
          "quantity-sold": "4", 
          "quantity-unsold": "16"
        },
        {
          "flower": "dandelion", 
          "date": "2/7/2012", 
          "quantity-sold": "7", 
          "quantity-unsold": "8"
        }
      ]
      
      // var options = {
      //   //Boolean - Whether the scale should start at zero, or an order of magnitude down from the lowest value
      //   scaleBeginAtZero : true,
      //
      //   //Boolean - Whether grid lines are shown across the chart
      //   scaleShowGridLines : true,
      //
      //   //String - Colour of the grid lines
      //   scaleGridLineColor : "rgba(0,0,0,.05)",
      //
      //   //Number - Width of the grid lines
      //   scaleGridLineWidth : 1,
      //
      //   //Boolean - If there is a stroke on each bar
      //   barShowStroke : true,
      //
      //   //Number - Pixel width of the bar stroke
      //   barStrokeWidth : 2,
      //
      //   //Number - Spacing between each of the X value sets
      //   barValueSpacing : 5,
      //
      //   //Number - Spacing between data sets within X values
      //   barDatasetSpacing : 1,
      //
      //   //String - A legend template
      //   legendTemplate : "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].lineColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"
      //
      // }
    </script>

    <script>

      function breakOutByDate(data) {
        var dates = [];
        
        data.forEach(function (blob) {
          var date = blob.date;
          if (dates.indexOf(date) === -1) {
            dates.push(date);
          }
        });
        
        // build object with dates as keys
        var dataByDate = {};
        dates.forEach(function (date) {
          var dateInfo = dataByDate[date] = {};
          
          data.forEach(function (blob) {
            if (blob.date === date) {
              var flowerInfo = dateInfo[blob.flower] = {};
              var quantSold = parseInt(blob['quantity-sold']);
              var quantUnsold = parseInt(blob['quantity-unsold']);
              flowerInfo['sold'] = quantSold;
              flowerInfo['unsold'] = quantUnsold;
              flowerInfo['delivered'] = quantSold + quantUnsold;
            }
          });
        });
        
        return dataByDate;
      }
      
      
      
      var dataByDate = breakOutByDate(rawData);
      
      // different views:
      // delivered (total)
      // sold
      // unsold
      
      // view by: 
      // all flowers
      // single flowers
      
      function dailyTotalsForProperty(property) {
        var labels = Object.keys(dataByDate);
        var dataset = {
          label: "Total Flowers " + property,
          fillColor: "rgba(151,187,205,0.5)",
          strokeColor: "rgba(151,187,205,0.8)",
          highlightFill: "rgba(151,187,205,0.75)",
          highlightStroke: "rgba(151,187,205,1)",
          data: []
        };
        
        labels.forEach(function (label) {
          var totalSold = 0;
          var date = dataByDate[label];
          for (var flower in date) {
            totalSold += date[flower][property];
          };
        
          dataset.data.push(totalSold);
        })
      
        return {
          labels: labels,
          datasets: [dataset]
        };
      }
      
      function dailyByFlowerForProperty(property) {
        var labels = Object.keys(dataByDate);
        var datasetObj = {};
        
        var datasetDefaults = {
          fillColor: "rgba(151,187,205,0.5)",
          strokeColor: "rgba(151,187,205,0.8)",
          highlightFill: "rgba(151,187,205,0.75)",
          highlightStroke: "rgba(151,187,205,1)",
        };
        
        // get flower names
        var flowers = [];
        for (var dateBlob in dataByDate) {
          var dateBlob = dataByDate[dateBlob];
          _.forIn(dateBlob, function (data, flower) {
            if (!_.contains(flowers, flower)) {
              flowers.push(flower);
            }      
          })
        }
        
        _.each(flowers, function (flower) {
          var dataset = datasetObj[flower] = _.assign({ 
            label: flower,
            data: []
          }, datasetDefaults);
          
          labels.forEach(function (label) {
            var dateBlob = dataByDate[label];
            dataset.data.push(dateBlob[flower][property]);
          });
        });
        
        
        var datasetArr = [];
        for (var key in datasetObj) {
          datasetArr.push(datasetObj[key]);
        }
      
        return {
          labels: labels,
          datasets: datasetArr
        };
      }

      // var totalSoldData = quantityTotal('sold');
      // var totalSoldDataByFlower = quantityByFlower('sold');
      //
      // var totalUnsoldData = quantityTotal('unsold');
      // var totalUnsoldDataByFlower = quantityByFlower('unsold');

    </script>
      
    <script>
      
      function Dashboard(rootEl) {

        this.currentView = {
          property: 'sold',
          showTotal: true
        };
        this.chartOptions = {}
        this.rendered = false;
        
        this.flowerChart = new Chart(ctx);
      }
      
      Dashboard.prototype.showChart = function () {
        var data;
        
        if (this.currentView.showTotal) {
          data = dailyTotalsForProperty(this.currentView.property);
        } else {
          data = dailyByFlowerForProperty(this.currentView.property);          
        }
        
        if (this.rendered) {
          this.flowerChart.Bar(data, this.chartOptions);     
          this.rendered = true;     
        } else {
          this.flowerChart;
        }
        return this;
      };
      
      var dashboard = new Dashboard().showChart();
      
      showByFlower.onclick = (function () {
        dashboard.currentView.showTotal = false;
        dashboard.showChart();
        return false;
      });
      
      showTotal.onclick = (function () {
        dashboard.currentView.showTotal = true;
        dashboard.showChart();
        return false;
      });
      
    </script>
    
  </body>
  
</html>